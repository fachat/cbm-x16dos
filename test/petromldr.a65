
/*
 * this file installs the dosrom driver in bank 7 and patches the BASIC 4 ROM
 * to include the ROM usb companion functions.
 *
 * Therefore, at the end of this file, a page of companion code is expected that is
 * installed into $dfxx in BASIC ROM.
 * After that, up to 16k of USB driver code and data are expected, that are copied
 * to $1000 in bank 7 (where the USB driver code resides)
 */

COMPANION	=$fe00

	.word $0401
	*=$0401

	.word eol		; BASIC link pointer
	.word 10		; line number
	.byt $9e, "1040", 0	; BASIC code (tokenized)
eol	.word 0			; BASIC link pointer, 0 means end of code
	.dsb 1040-*

	; start after sys
	sei

	; native mode
	clc
	xce
	; 16bit index registers
	rep #%00010000
	.xl
	
	; make ROM writable
	lda #%01100000
	sta $e801

	; copy petromcomp over ROM at page $dfxx
	ldy #0
pc1	lda petrom,y
	sta COMPANION,y
	iny
	cpy #dosrom - petrom
	bne pc1

	; write-protect ROM again
	lda #%11100000
	sta $e801	

	ldx #0
pc2	lda dosrom,x
	sta $074000,x
	inx
	cpx #end - dosrom
	bne pc2

	; 8bit index registers
	sep #%00010000
	.xs
	; emulation mode
	sec
	xce

	cli

	ldy #0
tl	lda text,y
	beq tend
	jsr $ffd2
	iny
	bne tl
tend	rts
text
	.asc 13,"INIT WITH ",13,"SYS 65024",13, 0	
petrom
	.bin 0,0, "dosromcomp"
dosrom
	.bin 0,0, "dos.bin"
end
